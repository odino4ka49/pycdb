/** * Created by 1ka on 4/5/14. */ZOOMPYCDB.namespace("ZOOMPYCDB.GraphController");ZOOMPYCDB.GraphController = function(model,view){    var keyboard = view.keyboard,        view = view.graph,        storage = model.storage,        temp_data = model.temp;    $(document).on("node_clicked",function(event,d){        var chosen_rel = temp_data.getChosenRel(),            chosen_source = temp_data.getChosenSource();        //when we chose rid and source of new relation        if(chosen_rel!=undefined){            if(chosen_source!=undefined){            	console.log(chosen_source);            	if(chosen_source instanceof Array){            		storage.addRelationFromSelection(chosen_rel.id,chosen_source,d);            	}            	else{	                storage.addRelation(chosen_rel.id,temp_data.getChosenSource(),d);	            }                temp_data.setChosenSource(undefined);                temp_data.setChosenRel(undefined);                view.closeDragLine();                storage.unhighlight();            }            //when we chose rid            else{                temp_data.setChosenSource(d);                storage.highlightRelTargets(chosen_rel, d);                view.addDragLine(chosen_rel,{x: d.x,y: d.y});            }        }        //when we picked an object to watch information        else{            storage.unhighlight();            $(document).trigger("unselect_rect");            //frame around chosen node            d.chosen = true;            storage.changeNode(d);            temp_data.setNode(d);        }    });    $(document).on("rel_clicked",function(event,d){        storage.unhighlight();        $(document).trigger("unselect_rect");        temp_data.setRelation(d);    });    $(document).on("bg_clicked",function(event,d){        if(keyboard.isCtrlPressed())        {            storage.unhighlight();            $(document).trigger("unselect_rect");            d.chosen = true;            storage.changeBg(d);            temp_data.setBackground(d);        }    });    $(document).on("selection_clicked",function(event,d){    	var chosen_rel = temp_data.getChosenRel(),            chosen_source = temp_data.getChosenSource();        //when we chose rid and source of new relation        if(chosen_rel!=undefined){            if(chosen_source!=undefined){                storage.addRelationToSelection(chosen_rel.id,temp_data.getChosenSource());                temp_data.setChosenSource(undefined);                temp_data.setChosenRel(undefined);                view.closeDragLine();                storage.unhighlight();            }            //when we chose rid            else{            	var source = storage.getSelectedFragment().nodes;                temp_data.setChosenSource(source);                storage.highlightRelTargets(chosen_rel, source);                view.addDragLine(chosen_rel,view.getMouseCoord());            }        }        //when we picked an object to watch information        else{            storage.unhighlight();            $(document).trigger("unselect_rect");            //frame around chosen node            d.chosen = true;            storage.changeNode(d);            temp_data.setNode(d);        }    });    $(document).on("graph_mouse_moved",function(e,event){        view.moveDragLine();        view.changeSelectionRect(event);        $(document).trigger("close_selection");    });    $(document).on("graph_mouse_down",function(e,event){        if(event.shiftKey){            view.removeSelectionRect();            storage.cleanSelection();            view.startSelectionRect();        }    });    $(document).on("unselect_rect",function(){    	view.removeSelectionRect();    	$(document).trigger("close_selection");        //storage.closeSelection(view.getSelectionRect(),view.getScale());        //storage.selectFragment();    });    $(document).on("graph_mouse_click",function(){        //temp_data.setChosenSource(undefined);        //temp_data.setChosenRel(undefined);        //view.closeDragLine();        view.refresh();        //storage.unhighlight();    });    $(document).on("graph_mouse_dblclick",function(){        temp_data.setChosenSource(undefined);        temp_data.setChosenRel(undefined);        view.closeDragLine();        //view.refresh();        storage.unhighlight();    });    $(document).on("graph_mouse_up",function(){        if(!view.isSelectionClosed()){            view.closeSelectionRect();            storage.closeSelection(view.getSelectionRect(),view.getScale());            storage.unhighlight();            temp_data.setNodesGroup(storage.getSelectedFragment(view.getSelectionRect()));        }    });    $(document).on("close_selection",function(){        if(!view.isSelectionClosed()){            storage.closeSelection(view.getSelectionRect(),view.getScale());            //storage.unhighlight();            //temp_data.setNodesGroup(storage.getSelectedFragment(view.getSelectionRect()));        }    });    $(document).on("check_selection",function(){        //storage.closeSelection(view.getSelectionRect(),view.getScale());        temp_data.setNodesGroup(storage.getSelectedFragment(view.getSelectionRect()));    });    $(document).on("ctrl+c",function(){        temp_data.setFragment(storage.getSelectedFragment(view.getSelectionRect()));    });    $(document).on("ctrl+x",function(){        temp_data.setFragment(storage.getSelectedFragment(view.getSelectionRect()));        storage.removeSelectedFragment();        view.closeSelectionRect();        $(document).trigger("unselect_rect");    });    $(document).on("selection_pasted",function(){        var selection,rect;        //if(view.isMouseOver()){            view.closeSelectionRect();            view.removeSelectionRect();            storage.closeSelection(view.getSelectionRect(),view.getScale());            selection = temp_data.getFragment(view.getMouseCoord());            rect = selection.rect;            view.addSelectionRect(rect.x,rect.y,rect.width,rect.height);            storage.pasteFragment(selection);        //}    });    $(document).on("bg_pasted",function(event,url,scale){        var coord = view.getMouseCoord();        storage.addBackground(url,scale,coord);    });    $(document).on("moved",function(event,node){        storage.changeNodeCoord(node);    });    $(document).on("bg_moved",function(event,bg){        storage.changeBgCoord(bg);    });    $(document).on("node_moved",function(event,node){        storage.changeNodeCoord(node);    });    $(document).on("drag_ended",function(event,node){        storage.saveNodeCoord(node);    });    $(document).on("drag_bg_ended",function(event,bg){        storage.saveBackground(bg);    });    $(document).on("selection_moved",function(){        var shift = view.getShift();        view.moveSelectionRect(shift);        storage.moveSelection(shift);    });    $(document).on("end_move_selection",function(){        view.endMoveSelectionRect();        storage.saveSelectionCoord();    });    return{    };};